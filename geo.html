<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ö–æ—Ç–∞ –∑–∞ –∫–ª–∞–¥–∞–º–∏</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #map {
            flex-grow: 1;
            z-index: 1;
        }
        #ui {
            padding: 15px;
            background: #2c3e50;
            color: white;
            border-top: 2px solid #34495e;
            z-index: 2;
            max-height: 40vh;
            overflow-y: auto;
        }
        #treasures {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .treasure-icon {
            width: 40px;
            height: 40px;
            background-color: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
            opacity: 0.5;
            transition: all 0.3s;
            border: 2px solid #e67e22;
        }
        .treasure-icon.found {
            opacity: 1;
            box-shadow: 0 0 10px #f1c40f;
            background-color: #f1c40f;
            transform: scale(1.1);
        }
        .marker-icon {
            background: #e74c3c;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border: 2px solid #c0392b;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        #distance {
            font-size: 1.1em;
            margin: 10px 0;
            color: #f1c40f;
        }
        #hint {
            margin: 10px 0;
            font-style: italic;
            color: #bdc3c7;
        }
        #start-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #start-btn:hover {
            background: #2ecc71;
        }
        .mini-game {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        .mini-game-content {
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
        }
        .mini-game button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .mini-game button:hover {
            background: #2980b9;
        }
        #memory-game {
            display: grid;
            grid-template-columns: repeat(4, 60px);
            gap: 10px;
            margin: 20px 0;
        }
        .memory-card {
            width: 60px;
            height: 60px;
            background: #3498db;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            border-radius: 5px;
        }
        .memory-card.flipped {
            background: #2ecc71;
        }
        #math-game input {
            padding: 10px;
            font-size: 1.2em;
            width: 100px;
            margin: 10px;
        }
        #sequence-game .sequence-item {
            padding: 15px;
            margin: 5px;
            background: #9b59b6;
            display: inline-block;
            cursor: pointer;
            border-radius: 5px;
        }
        #sequence-game .sequence-item.selected {
            background: #8e44ad;
            box-shadow: 0 0 5px #9b59b6;
        }
        #custom-treasure-info {
            background: #34495e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #f39c12;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="map"></div>
        <div id="ui">
            <h2>–û—Ö–æ—Ç–∞ –∑–∞ –∫–ª–∞–¥–∞–º–∏</h2>
            <p>–ù–∞–π–¥–∏—Ç–µ –≤—Å–µ 10 –∫–ª–∞–¥–æ–≤, —Å–ø—Ä—è—Ç–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–¥–∏—É—Å–µ 100-900 –º–µ—Ç—Ä–æ–≤ –æ—Ç –≤–∞—Å!</p>
            
            <div id="custom-treasure-info">
                <h3>–û—Å–æ–±—ã–π –∫–ª–∞–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ)</h3>
                <p id="custom-treasure-desc">–ó–æ–ª–æ—Ç–∞—è —Å—Ç–∞—Ç—É—è –ª—å–≤–∞ - —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç</p>
                <p>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: <span id="custom-treasure-coords">53.138116, 29.159999 (—à–∫–æ–ª–∞)</span></p>
            </div>
            
            <div id="distance">–î–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫–ª–∞–¥–∞: -</div>
            <div id="hint"></div>
            <div id="treasures"></div>
            <button id="start-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </div>

    <!-- –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ü–∞–º—è—Ç—å -->
    <div id="memory-game-container" class="mini-game" style="display: none;">
        <div class="mini-game-content">
            <h2>–ù–∞–π–¥–∏ –ø–∞—Ä—ã!</h2>
            <p>–û—Ç–∫—Ä–æ–π—Ç–µ –≤—Å–µ –ø–∞—Ä–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∞–¥</p>
            <div id="memory-game"></div>
            <button id="memory-game-close" style="display: none;">–ü–æ–ª—É—á–∏—Ç—å –∫–ª–∞–¥!</button>
        </div>
    </div>

    <!-- –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ -->
    <div id="math-game-container" class="mini-game" style="display: none;">
        <div class="mini-game-content">
            <h2>–†–µ—à–∏ –ø—Ä–∏–º–µ—Ä!</h2>
            <p>–†–µ—à–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∞–¥</p>
            <div id="math-game-question"></div>
            <input type="number" id="math-game-answer" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç">
            <button id="math-game-submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <p id="math-game-feedback"></p>
        </div>
    </div>

    <!-- –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å -->
    <div id="sequence-game-container" class="mini-game" style="display: none;">
        <div class="mini-game-content">
            <h2>–ó–∞–ø–æ–º–Ω–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å!</h2>
            <p>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–ª–∞–¥</p>
            <div id="sequence-game-display"></div>
            <div id="sequence-game-input" style="margin-top: 20px;"></div>
            <p id="sequence-game-feedback"></p>
            <button id="sequence-game-start" style="display: none;">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        const gameConfig = {
            treasures: [
                {id: 1, name: "–ó–æ–ª–æ—Ç–∞—è –º–æ–Ω–µ—Ç–∞", found: false, difficulty: "easy"},
                {id: 2, name: "–°—Ç–∞—Ä–∏–Ω–Ω—ã–π —Å–≤–∏—Ç–æ–∫", found: false, difficulty: "medium"},
                {id: 3, name: "–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å", found: false, difficulty: "hard"},
                {id: 4, name: "–ó–∞–≥–∞–¥–æ—á–Ω—ã–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç", found: false, difficulty: "easy"},
                {id: 5, name: "–°—É–Ω–¥—É–∫ —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏", found: false, difficulty: "medium"},
                {id: 6, name: "–ö–æ—Ä–æ–Ω–∞ –¥—Ä–µ–≤–Ω–µ–≥–æ –∫–æ—Ä–æ–ª—è", found: false, difficulty: "hard"},
                {id: 7, name: "–ö–∞—Ä—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â", found: false, difficulty: "easy"},
                {id: 8, name: "–í–æ–ª—à–µ–±–Ω—ã–π –∞–º—É–ª–µ—Ç", found: false, difficulty: "medium"},
                {id: 9, name: "–ö–ª–∞–¥ –ø–∏—Ä–∞—Ç–æ–≤", found: false, difficulty: "hard"},
                {id: 10, name: "–ó–æ–ª–æ—Ç–∞—è —Å—Ç–∞—Ç—É—è –ª—å–≤–∞", found: false, difficulty: "custom",
                 custom: true, lat: 53.138116, lng: 29.159999, 
                 description: "–ó–æ–ª–æ—Ç–∞—è —Å—Ç–∞—Ç—É—è –ª—å–≤–∞ - —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç"}
            ],
            collectionRadius: 5, // –º–µ—Ç—Ä–æ–≤ (—Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–æ 5!)
            minDistance: 100, // –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∫–ª–∞–¥–∞ (–º–µ—Ç—Ä—ã)
            maxDistance: 900 // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∫–ª–∞–¥–∞ (–º–µ—Ç—Ä—ã)
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const mapElement = document.getElementById('map');
        const distanceElement = document.getElementById('distance');
        const hintElement = document.getElementById('hint');
        const treasuresElement = document.getElementById('treasures');
        const startBtn = document.getElementById('start-btn');
        const customTreasureDesc = document.getElementById('custom-treasure-desc');
        const customTreasureCoords = document.getElementById('custom-treasure-coords');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–∏–Ω–∏-–∏–≥—Ä
        const memoryGameContainer = document.getElementById('memory-game-container');
        const memoryGame = document.getElementById('memory-game');
        const memoryGameCloseBtn = document.getElementById('memory-game-close');
        
        const mathGameContainer = document.getElementById('math-game-container');
        const mathGameQuestion = document.getElementById('math-game-question');
        const mathGameAnswer = document.getElementById('math-game-answer');
        const mathGameSubmit = document.getElementById('math-game-submit');
        const mathGameFeedback = document.getElementById('math-game-feedback');
        
        const sequenceGameContainer = document.getElementById('sequence-game-container');
        const sequenceGameDisplay = document.getElementById('sequence-game-display');
        const sequenceGameInput = document.getElementById('sequence-game-input');
        const sequenceGameFeedback = document.getElementById('sequence-game-feedback');
        const sequenceGameStartBtn = document.getElementById('sequence-game-start');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
        let map;
        let userMarker;
        let treasureMarkers = [];
        let watchId;
        let userPosition = null;
        let currentTreasure = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∏–Ω–∏-–∏–≥—Ä
        let memoryCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        
        let mathSolution = 0;
        
        let sequencePattern = [];
        let sequenceInput = [];
        let sequenceItems = ['A', 'B', 'C', 'D', 'E'];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∫–ª–∞–¥–µ
            const customTreasure = gameConfig.treasures.find(t => t.custom);
            if (customTreasure) {
                customTreasureDesc.textContent = customTreasure.description;
                customTreasureCoords.textContent = `${customTreasure.lat}, ${customTreasure.lng}`;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É (—Ü–µ–Ω—Ç—Ä –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏)
            map = L.map('map').setView([0, 0], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // –°–æ–∑–¥–∞–µ–º UI –¥–ª—è —Å–æ–∫—Ä–æ–≤–∏—â
            renderTreasuresUI();
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            startGeolocation();
            
            startBtn.textContent = "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É";
        }

        // –†–µ–Ω–¥–µ—Ä UI —Å–æ–∫—Ä–æ–≤–∏—â
        function renderTreasuresUI() {
            treasuresElement.innerHTML = '';
            gameConfig.treasures.forEach(treasure => {
                const treasureEl = document.createElement('div');
                treasureEl.className = `treasure-icon ${treasure.found ? 'found' : ''}`;
                treasureEl.textContent = treasure.id;
                treasureEl.title = `${treasure.name} (${getDifficultyName(treasure.difficulty)})`;
                treasuresElement.appendChild(treasureEl);
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        function getDifficultyName(difficulty) {
            switch(difficulty) {
                case 'easy': return '–õ—ë–≥–∫–∏–π';
                case 'medium': return '–°—Ä–µ–¥–Ω–∏–π';
                case 'hard': return '–°–ª–æ–∂–Ω—ã–π';
                case 'custom': return '–û—Å–æ–±—ã–π';
                default: return '';
            }
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–æ–∫—Ä–æ–≤–∏—â –Ω–∞ –∫–∞—Ä—Ç–µ
        function placeTreasures() {
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            treasureMarkers.forEach(item => map.removeLayer(item.marker));
            treasureMarkers = [];
            
            if (!userPosition) return;

            // –†–∞–∑–º–µ—â–∞–µ–º —Å–æ–∫—Ä–æ–≤–∏—â–∞ –Ω–∞ —Å–ª—É—á–∞–π–Ω–æ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –æ—Ç 100 –¥–æ 900 –º–µ—Ç—Ä–æ–≤
            gameConfig.treasures.forEach(treasure => {
                if (!treasure.found) {
                    let treasurePos;
                    
                    // –î–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∞–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    if (treasure.custom) {
                        treasurePos = {
                            lat: treasure.lat,
                            lng: treasure.lng
                        };
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ –¥–∞–ª–µ–∫–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∞–¥
                        const distance = calculateDistance(
                            userPosition.lat, userPosition.lng,
                            treasurePos.lat, treasurePos.lng
                        );
                        
                        if (distance > gameConfig.maxDistance * 1.5) {
                            alert(`–í–Ω–∏–º–∞–Ω–∏–µ! –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∞–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ—á–µ–Ω—å –¥–∞–ª–µ–∫–æ (${Math.round(distance)} –º). –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –¥–æ –Ω–µ–≥–æ –¥–æ–±—Ä–∞—Ç—å—Å—è.`);
                        }
                    } else {
                        // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫–ª–∞–¥–æ–≤ - —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                        const distance = gameConfig.minDistance + 
                                      Math.random() * (gameConfig.maxDistance - gameConfig.minDistance);
                        const azimuth = Math.random() * 360;
                        
                        treasurePos = calculateDestinationPoint(
                            userPosition.lat,
                            userPosition.lng,
                            azimuth,
                            distance
                        );
                    }
                    
                    const marker = L.marker([treasurePos.lat, treasurePos.lng], {
                        icon: L.divIcon({
                            className: 'marker-icon',
                            html: treasure.id
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`<b>${treasure.name}</b><br>–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${getDifficultyName(treasure.difficulty)}`);
                    
                    treasureMarkers.push({
                        marker: marker,
                        treasure: treasure,
                        position: [treasurePos.lat, treasurePos.lng]
                    });
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
            updateHint();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
        function updateHint() {
            if (!userPosition || treasureMarkers.length === 0) {
                hintElement.textContent = "";
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ —Å–æ–∫—Ä–æ–≤–∏—â–µ
            let closestTreasure = null;
            let minDistance = Infinity;
            
            treasureMarkers.forEach(item => {
                const distance = calculateDistance(
                    userPosition.lat, userPosition.lng,
                    item.position[0], item.position[1]
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestTreasure = item;
                }
            });
            
            if (closestTreasure) {
                const direction = getDirection(
                    userPosition.lat, userPosition.lng,
                    closestTreasure.position[0], closestTreasure.position[1]
                );
                
                hintElement.textContent = `–ë–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞–¥ (${closestTreasure.treasure.name}) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è ${direction}, –ø—Ä–∏–º–µ—Ä–Ω–æ ${Math.round(minDistance)} –º –æ—Ç –≤–∞—Å`;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Å–µ–≤–µ—Ä, —é–≥–æ-–∑–∞–ø–∞–¥ –∏ —Ç.–¥.)
        function getDirection(lat1, lng1, lat2, lng2) {
            const dy = lat2 - lat1;
            const dx = Math.cos(Math.PI * lat1 / 180) * (lng2 - lng1);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            const directions = ['—Å–µ–≤–µ—Ä', '—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫', '–≤–æ—Å—Ç–æ–∫', '—é–≥–æ-–≤–æ—Å—Ç–æ–∫', 
                               '—é–≥', '—é–≥–æ-–∑–∞–ø–∞–¥', '–∑–∞–ø–∞–¥', '—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥'];
            const index = Math.round(((angle % 360) / 45)) % 8;
            return directions[(index + 8) % 8];
        }

        // –ó–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        function startGeolocation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    userPosition = pos;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–∞—Ä—Ç–µ
                    if (!userMarker) {
                        userMarker = L.marker([pos.lat, pos.lng]).addTo(map);
                        userMarker.bindPopup("<b>–í—ã –∑–¥–µ—Å—å!</b>").openPopup();
                        map.setView([pos.lat, pos.lng], 15);
                        
                        // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞–∑–º–µ—â–∞–µ–º —Å–æ–∫—Ä–æ–≤–∏—â–∞
                        placeTreasures();
                    } else {
                        userMarker.setLatLng([pos.lat, pos.lng]);
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä—è–¥–æ–º –ª–∏ —Å–æ–∫—Ä–æ–≤–∏—â–∞
                    checkTreasuresProximity(pos);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                    updateHint();
                },
                error => {
                    console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.");
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ —Å–æ–∫—Ä–æ–≤–∏—â–∞–º
        function checkTreasuresProximity(userPos) {
            let minDistance = Infinity;
            
            treasureMarkers.forEach((item, index) => {
                if (!item.treasure.found) {
                    const distance = calculateDistance(
                        userPos.lat, userPos.lng,
                        item.position[0], item.position[1]
                    );
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
                    if (distance < minDistance) {
                        minDistance = distance;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –±–ª–∏–∑–∫–æ –∫ —Å–æ–∫—Ä–æ–≤–∏—â—É (—Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–æ 5 –º–µ—Ç—Ä–æ–≤!)
                    if (distance <= gameConfig.collectionRadius) {
                        currentTreasure = item.treasure;
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–Ω–∏-–∏–≥—Ä—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                        startMiniGame(currentTreasure.difficulty);
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–µ–π
            distanceElement.textContent = minDistance === Infinity ? 
                "–í—Å–µ –∫–ª–∞–¥—ã —Å–æ–±—Ä–∞–Ω—ã!" : 
                `–î–∏—Å—Ç–∞–Ω—Ü–∏—è –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫–ª–∞–¥–∞: ${Math.round(minDistance)} –º`;
        }

        // –ó–∞–ø—É—Å–∫ –º–∏–Ω–∏-–∏–≥—Ä—ã
        function startMiniGame(difficulty) {
            // –í—ã–±–∏—Ä–∞–µ–º –º–∏–Ω–∏-–∏–≥—Ä—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if (difficulty === 'easy') {
                startMemoryGame(4); // 4 –ø–∞—Ä—ã –¥–ª—è –ª—ë–≥–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è
            } else if (difficulty === 'medium') {
                startMathGame();
            } else if (difficulty === 'hard') {
                startSequenceGame(5); // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            } else if (difficulty === 'custom') {
                startMemoryGame(6); // –î–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∞–¥–∞ - —Å–ª–æ–∂–Ω–∞—è –∏–≥—Ä–∞ –Ω–∞ –ø–∞–º—è—Ç—å
            }
        }

        // –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ü–∞–º—è—Ç—å (–Ω–∞–π–¥–∏ –ø–∞—Ä—ã)
        function startMemoryGame(pairsCount) {
            memoryGame.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;
            memoryCards = [];
            
            // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—ã –∫–∞—Ä—Ç–æ—á–µ–∫
            const symbols = ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', 'üçé', 'üçì', 'üçë'];
            const selectedSymbols = symbols.slice(0, pairsCount);
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –¥–≤—É–º—è –∫–æ–ø–∏—è–º–∏ –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
            for (let i = 0; i < pairsCount; i++) {
                memoryCards.push(selectedSymbols[i]);
                memoryCards.push(selectedSymbols[i]);
            }
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            memoryCards = shuffleArray(memoryCards);
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –ø–æ–ª–µ
            memoryCards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.index = index;
                card.dataset.symbol = symbol;
                card.addEventListener('click', flipCard);
                memoryGame.appendChild(card);
            });
            
            memoryGameContainer.style.display = 'flex';
        }

        // –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –∏–≥—Ä–µ –Ω–∞ –ø–∞–º—è—Ç—å
        function flipCard() {
            const card = this;
            
            // –ù–µ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∏–ª–∏ —Å–æ–≤–ø–∞–≤—à–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            if (card.classList.contains('flipped') || flippedCards.length >= 2) {
                return;
            }
            
            card.classList.add('flipped');
            card.textContent = card.dataset.symbol;
            flippedCards.push(card);
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ 2 –∫–∞—Ä—Ç–æ—á–∫–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            if (flippedCards.length === 2) {
                setTimeout(checkForMatch, 500);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
        function checkForMatch() {
            const [card1, card2] = flippedCards;
            
            if (card1.dataset.symbol === card2.dataset.symbol) {
                // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                card1.removeEventListener('click', flipCard);
                card2.removeEventListener('click', flipCard);
                matchedPairs++;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –ø–∞—Ä—ã –Ω–∞–π–¥–µ–Ω—ã
                if (matchedPairs === memoryCards.length / 2) {
                    memoryGameCloseBtn.style.display = 'block';
                }
            } else {
                // –ù–µ —Å–æ–≤–ø–∞–ª–∏ - –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
                card1.classList.remove('flipped');
                card2.classList.remove('flipped');
                card1.textContent = '';
                card2.textContent = '';
            }
            
            flippedCards = [];
        }

        // –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
        function startMathGame() {
            mathGameFeedback.textContent = '';
            mathGameAnswer.value = '';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä
            const a = Math.floor(Math.random() * 10) + 1;
            const b = Math.floor(Math.random() * 10) + 1;
            const operators = ['+', '-', '*'];
            const operator = operators[Math.floor(Math.random() * operators.length)];
            
            let question = '';
            switch(operator) {
                case '+': 
                    question = `${a} + ${b}`;
                    mathSolution = a + b;
                    break;
                case '-': 
                    question = `${a} - ${b}`;
                    mathSolution = a - b;
                    break;
                case '*': 
                    question = `${a} √ó ${b}`;
                    mathSolution = a * b;
                    break;
            }
            
            mathGameQuestion.textContent = `–†–µ—à–∏—Ç–µ: ${question} = ?`;
            mathGameContainer.style.display = 'flex';
        }

        // –ú–∏–Ω–∏-–∏–≥—Ä–∞: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        function startSequenceGame(length) {
            sequenceGameDisplay.innerHTML = '';
            sequenceGameInput.innerHTML = '';
            sequenceGameFeedback.textContent = '';
            sequenceGameStartBtn.style.display = 'none';
            sequenceInput = [];
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            sequencePattern = [];
            for (let i = 0; i < length; i++) {
                const item = sequenceItems[Math.floor(Math.random() * sequenceItems.length)];
                sequencePattern.push(item);
                
                const displayItem = document.createElement('span');
                displayItem.className = 'sequence-item';
                displayItem.textContent = item;
                sequenceGameDisplay.appendChild(displayItem);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                sequenceGameDisplay.innerHTML = '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:';
                createSequenceInput();
            }, 2000);
            
            sequenceGameContainer.style.display = 'flex';
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–≤–æ–¥–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function createSequenceInput() {
            sequenceItems.forEach(item => {
                const inputItem = document.createElement('span');
                inputItem.className = 'sequence-item';
                inputItem.textContent = item;
                inputItem.addEventListener('click', () => {
                    sequenceInput.push(item);
                    inputItem.classList.add('selected');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                    checkSequence();
                });
                sequenceGameInput.appendChild(inputItem);
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function checkSequence() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –≤–≤–µ–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            for (let i = 0; i < sequenceInput.length; i++) {
                if (sequenceInput[i] !== sequencePattern[i]) {
                    // –û—à–∏–±–∫–∞
                    sequenceGameFeedback.textContent = '–ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                    sequenceGameStartBtn.style.display = 'block';
                    sequenceInput = [];
                    return;
                }
            }
            
            // –ï—Å–ª–∏ –≤—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–∞ –≤–µ—Ä–Ω–æ
            if (sequenceInput.length === sequencePattern.length) {
                sequenceGameFeedback.textContent = '–í–µ—Ä–Ω–æ! –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–ª–∞–¥!';
                finishMiniGame(true);
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏–Ω–∏-–∏–≥—Ä—ã
        function finishMiniGame(success) {
            if (success) {
                // –ü–æ–º–µ—á–∞–µ–º —Å–æ–∫—Ä–æ–≤–∏—â–µ –∫–∞–∫ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ
                currentTreasure.found = true;
                
                // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Å –∫–∞—Ä—Ç—ã
                const treasureMarker = treasureMarkers.find(item => item.treasure === currentTreasure);
                if (treasureMarker) {
                    map.removeLayer(treasureMarker.marker);
                    treasureMarkers = treasureMarkers.filter(item => item.treasure !== currentTreasure);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                renderTreasuresUI();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —Å–æ–∫—Ä–æ–≤–∏—â–∞ —Å–æ–±—Ä–∞–Ω—ã
                checkGameCompletion();
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–∏–Ω–∏-–∏–≥—Ä—ã
            memoryGameContainer.style.display = 'none';
            mathGameContainer.style.display = 'none';
            sequenceGameContainer.style.display = 'none';
            
            currentTreasure = null;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
        function checkGameCompletion() {
            const allFound = gameConfig.treasures.every(t => t.found);
            if (allFound) {
                alert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —Å–æ–±—Ä–∞–ª–∏ –≤—Å–µ –∫–ª–∞–¥—ã –≥–æ—Ä–æ–¥–∞!");
                distanceElement.textContent = "–í—Å–µ –∫–ª–∞–¥—ã —Å–æ–±—Ä–∞–Ω—ã!";
                hintElement.textContent = "";
            }
        }

        // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –≤ –º–µ—Ç—Ä–∞—Ö (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–æ–≤)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // –†–∞—Å—á–µ—Ç —Ç–æ—á–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (–≤ –º–µ—Ç—Ä–∞—Ö –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏)
        function calculateDestinationPoint(lat, lng, azimuth, distance) {
            const R = 6371e3; // —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
            const brng = azimuth * Math.PI / 180; // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ä–∞–¥–∏–∞–Ω—ã
            const œÜ1 = lat * Math.PI / 180;
            const Œª1 = lng * Math.PI / 180;
            
            const œÜ2 = Math.asin(Math.sin(œÜ1) * Math.cos(distance / R) + 
                      Math.cos(œÜ1) * Math.sin(distance / R) * Math.cos(brng));
            
            const Œª2 = Œª1 + Math.atan2(
                Math.sin(brng) * Math.sin(distance / R) * Math.cos(œÜ1),
                Math.cos(distance / R) - Math.sin(œÜ1) * Math.sin(œÜ2)
            );
            
            return {
                lat: œÜ2 * 180 / Math.PI,
                lng: Œª2 * 180 / Math.PI
            };
        }

        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç–∞
        startBtn.addEventListener('click', () => {
            // –°–±—Ä–æ—Å –∏–≥—Ä—ã
            gameConfig.treasures.forEach(t => t.found = false);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = null;
            userPosition = null;
            treasureMarkers.forEach(item => map.removeLayer(item.marker));
            treasureMarkers = [];
            
            initGame();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–∏–Ω–∏-–∏–≥—Ä
        memoryGameCloseBtn.addEventListener('click', () => {
            finishMiniGame(true);
        });
        
        mathGameSubmit.addEventListener('click', () => {
            const userAnswer = parseInt(mathGameAnswer.value);
            if (isNaN(userAnswer)) {
                mathGameFeedback.textContent = '–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!';
                return;
            }
            
            if (userAnswer === mathSolution) {
                mathGameFeedback.textContent = '–í–µ—Ä–Ω–æ! –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–ª–∞–¥!';
                setTimeout(() => finishMiniGame(true), 1000);
            } else {
                mathGameFeedback.textContent = '–ù–µ–≤–µ—Ä–Ω–æ! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
                mathGameAnswer.value = '';
            }
        });
        
        mathGameAnswer.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                mathGameSubmit.click();
            }
        });
        
        sequenceGameStartBtn.addEventListener('click', () => {
            startSequenceGame(sequencePattern.length);
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        if (!navigator.geolocation) {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, –∏–≥—Ä–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.");
            startBtn.disabled = true;
        }
    </script>
</body>
</html>
