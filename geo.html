<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сокровища моего города</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #map {
            flex-grow: 1;
            z-index: 1;
        }
        #ui {
            padding: 10px;
            background: #f0f0f0;
            border-top: 1px solid #ccc;
            z-index: 2;
        }
        #treasures {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .treasure-icon {
            width: 30px;
            height: 30px;
            background-color: gold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            opacity: 0.3;
        }
        .treasure-icon.found {
            opacity: 1;
            box-shadow: 0 0 5px gold;
        }
        .marker-icon {
            background: red;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        #hint {
            margin-top: 10px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="map"></div>
        <div id="ui">
            <h2>Сокровища моего города</h2>
            <p>Доберитесь до всех точек на карте, чтобы собрать сокровища! Каждое сокровище находится примерно в 1 км от вас.</p>
            <div id="distance">Дистанция до ближайшего сокровища: -</div>
            <div id="hint"></div>
            <div id="treasures"></div>
            <button id="start-btn">Начать игру</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Конфигурация игры
        const gameConfig = {
            treasures: [
                {id: 1, name: "Золотая монета", found: false},
                {id: 2, name: "Старинный свиток", found: false},
                {id: 3, name: "Драгоценный камень", found: false},
                {id: 4, name: "Загадочный артефакт", found: false},
                {id: 5, name: "Сундук с сокровищами", found: false}
            ],
            collectionRadius: 50, // метров
            treasureDistance: 1000 // метров (1 км)
        };

        // Элементы DOM
        const mapElement = document.getElementById('map');
        const distanceElement = document.getElementById('distance');
        const hintElement = document.getElementById('hint');
        const treasuresElement = document.getElementById('treasures');
        const startBtn = document.getElementById('start-btn');

        // Переменные игры
        let map;
        let userMarker;
        let treasureMarkers = [];
        let watchId;
        let userPosition = null;

        // Инициализация игры
        function initGame() {
            // Создаем карту (центр будет установлен при получении геолокации)
            map = L.map('map').setView([0, 0], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Создаем UI для сокровищ
            renderTreasuresUI();
            
            // Запрашиваем геолокацию
            startGeolocation();
            
            startBtn.textContent = "Перезапустить игру";
        }

        // Рендер UI сокровищ
        function renderTreasuresUI() {
            treasuresElement.innerHTML = '';
            gameConfig.treasures.forEach(treasure => {
                const treasureEl = document.createElement('div');
                treasureEl.className = `treasure-icon ${treasure.found ? 'found' : ''}`;
                treasureEl.textContent = treasure.id;
                treasureEl.title = treasure.name;
                treasuresElement.appendChild(treasureEl);
            });
        }

        // Размещение сокровищ на карте (примерно в 1 км от игрока)
        function placeTreasures() {
            // Очищаем старые маркеры
            treasureMarkers.forEach(item => map.removeLayer(item.marker));
            treasureMarkers = [];
            
            if (!userPosition) return;

            // Размещаем сокровища на расстоянии ~1 км от игрока
            gameConfig.treasures.forEach(treasure => {
                if (!treasure.found) {
                    // Генерируем случайный азимут (направление) в градусах
                    const azimuth = Math.random() * 360;
                    
                    // Вычисляем новую точку в 1 км от игрока в случайном направлении
                    const treasurePos = calculateDestinationPoint(
                        userPosition.lat,
                        userPosition.lng,
                        azimuth,
                        gameConfig.treasureDistance
                    );
                    
                    const marker = L.marker([treasurePos.lat, treasurePos.lng], {
                        icon: L.divIcon({
                            className: 'marker-icon',
                            html: treasure.id
                        })
                    }).addTo(map);
                    
                    marker.bindPopup(`<b>${treasure.name}</b><br>Идите к этой точке, чтобы собрать сокровище!`);
                    
                    treasureMarkers.push({
                        marker: marker,
                        treasure: treasure,
                        position: [treasurePos.lat, treasurePos.lng]
                    });
                }
            });
            
            // Обновляем подсказку
            updateHint();
        }

        // Обновление подсказки о направлении
        function updateHint() {
            if (!userPosition || treasureMarkers.length === 0) {
                hintElement.textContent = "";
                return;
            }
            
            // Находим ближайшее сокровище
            let closestTreasure = null;
            let minDistance = Infinity;
            
            treasureMarkers.forEach(item => {
                const distance = calculateDistance(
                    userPosition.lat, userPosition.lng,
                    item.position[0], item.position[1]
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestTreasure = item;
                }
            });
            
            if (closestTreasure) {
                const direction = getDirection(
                    userPosition.lat, userPosition.lng,
                    closestTreasure.position[0], closestTreasure.position[1]
                );
                
                hintElement.textContent = `Ближайшее сокровище (${closestTreasure.treasure.name}) находится ${direction}, примерно ${Math.round(minDistance)} м от вас`;
            }
        }

        // Получение направления (север, юго-запад и т.д.)
        function getDirection(lat1, lng1, lat2, lng2) {
            const dy = lat2 - lat1;
            const dx = Math.cos(Math.PI * lat1 / 180) * (lng2 - lng1);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            const directions = ['север', 'северо-восток', 'восток', 'юго-восток', 
                               'юг', 'юго-запад', 'запад', 'северо-запад'];
            const index = Math.round(((angle % 360) / 45)) % 8;
            return directions[(index + 8) % 8];
        }

        // Запуск отслеживания геолокации
        function startGeolocation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    userPosition = pos;
                    
                    // Обновляем позицию пользователя на карте
                    if (!userMarker) {
                        userMarker = L.marker([pos.lat, pos.lng]).addTo(map);
                        userMarker.bindPopup("<b>Вы здесь!</b>").openPopup();
                        map.setView([pos.lat, pos.lng], 15);
                        
                        // При первом получении позиции размещаем сокровища
                        placeTreasures();
                    } else {
                        userMarker.setLatLng([pos.lat, pos.lng]);
                    }
                    
                    // Проверяем, рядом ли сокровища
                    checkTreasuresProximity(pos);
                    
                    // Обновляем подсказку
                    updateHint();
                },
                error => {
                    console.error("Ошибка геолокации:", error);
                    alert("Не удалось получить ваше местоположение. Убедитесь, что вы разрешили доступ к геолокации.");
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );
        }

        // Проверка близости к сокровищам
        function checkTreasuresProximity(userPos) {
            let minDistance = Infinity;
            
            treasureMarkers.forEach((item, index) => {
                if (!item.treasure.found) {
                    const distance = calculateDistance(
                        userPos.lat, userPos.lng,
                        item.position[0], item.position[1]
                    );
                    
                    // Обновляем минимальную дистанцию
                    if (distance < minDistance) {
                        minDistance = distance;
                    }
                    
                    // Проверяем, достаточно ли близко к сокровищу
                    if (distance <= gameConfig.collectionRadius) {
                        // Собираем сокровище!
                        item.treasure.found = true;
                        map.removeLayer(item.marker);
                        treasureMarkers.splice(index, 1);
                        
                        alert(`Вы нашли ${item.treasure.name}!`);
                        renderTreasuresUI();
                        
                        // Проверяем, все ли сокровища собраны
                        checkGameCompletion();
                    }
                }
            });
            
            // Обновляем UI с дистанцией
            distanceElement.textContent = minDistance === Infinity ? 
                "Все сокровища собраны!" : 
                `Дистанция до ближайшего сокровища: ${Math.round(minDistance)} м`;
        }

        // Проверка завершения игры
        function checkGameCompletion() {
            const allFound = gameConfig.treasures.every(t => t.found);
            if (allFound) {
                alert("Поздравляем! Вы собрали все сокровища города!");
                distanceElement.textContent = "Все сокровища собраны!";
                hintElement.textContent = "";
            }
        }

        // Расчет расстояния между двумя точками в метрах (формула гаверсинусов)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // радиус Земли в метрах
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Расчет точки назначения (в метрах от начальной точки)
        function calculateDestinationPoint(lat, lng, azimuth, distance) {
            const R = 6371e3; // радиус Земли в метрах
            const brng = azimuth * Math.PI / 180; // преобразуем в радианы
            const φ1 = lat * Math.PI / 180;
            const λ1 = lng * Math.PI / 180;
            
            const φ2 = Math.asin(Math.sin(φ1) * Math.cos(distance / R) + 
                      Math.cos(φ1) * Math.sin(distance / R) * Math.cos(brng));
            
            const λ2 = λ1 + Math.atan2(
                Math.sin(brng) * Math.sin(distance / R) * Math.cos(φ1),
                Math.cos(distance / R) - Math.sin(φ1) * Math.sin(φ2)
            );
            
            return {
                lat: φ2 * 180 / Math.PI,
                lng: λ2 * 180 / Math.PI
            };
        }

        // Обработчик кнопки старта
        startBtn.addEventListener('click', () => {
            // Сброс игры
            gameConfig.treasures.forEach(t => t.found = false);
            if (userMarker) map.removeLayer(userMarker);
            userMarker = null;
            userPosition = null;
            treasureMarkers.forEach(item => map.removeLayer(item.marker));
            treasureMarkers = [];
            
            initGame();
        });

        // Проверяем поддержку геолокации
        if (!navigator.geolocation) {
            alert("Ваш браузер не поддерживает геолокацию, игра невозможна.");
            startBtn.disabled = true;
        }
    </script>
</body>
</html>
